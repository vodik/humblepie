#!/usr/bin/env bash
# vim: ft=sh
set -x
. ${HOME}/.config/humblepie/humblepie.rc

check_key() {
  ## grab the key
  # local k="$1" ret=0
  ## declare the array for keys
  declare -A bundlekeys
  ## expand all $hibkey_* variables from rcfile if they are set
  ## the quotes and @ are important for proper expansion
  for var in "${!hibkey_@}"; do
    ## this is an indirect expansion to test if any $hibkey_* expanded
    ## ${!var} will equal the value of each $hibkey_* in turn
    ## if hibkey_foo="barbazquux" then $var expands to "barbazquux"
    ## $var would be "hibkey_foo"
    ## ["hibkey_foo"]="barbazquux"
    # bundlekeys+=( ["${var##*_}"]="${var}" ) 
    # if [[ ${!bundlekeys@} ]]; then
    ## only populate array if there is a key defined
    [[ "${!var}" == "${hib_key}" ]] || {
      ## if no key found, cry
      broken "No keys discovered."
      verbose "ERROR" "No keys configured.\n" \
        "\tPlease specify a key with -k [key] or in your user's config file."
      return 1
    }
    k="${!var}"
    h="${var##*_}"
    bundlekeys+=(["$k"]="$h") 
  exit
  done
  verbose "INFO" "${#bundlekeys[@]} key found!"
}

generate_list() {
  ## unset for safety; declare an associative array
  unset IFS links; declare -Ag links sums
  capture=0
  while read -r key value; do
    # if ((capture == 1)); then
      ## check the line, make sure it's a proper link
      [[ "$value" = http://files.humblebundle.com/* ]] && {
        game="${value#http://files.humblebundle.com/}"
        ## strip everything after '?key=' to get a filename
        game="${game%%\?*}"
        links["$game"]="$value"
        md5="${game##*#}"
        sums["$game"]="$md5"
      }
    # else capture=1
    # fi
    ## read in the links dump
  done < \
    <(links -html-numbered-links 1 \
            -dump \
            "https://www.humblebundle.com/downloads?key=$1")
}

dl_game () {
    select choice in "${!links[@]}" quit; do
        [[ "$choice" = quit ]] && exit
        curl -s -o "${dir_hib}/${choice}" "${links[$choice]}" 2>/dev/null
    done
}
hib_key="$1"
check_key "$1"
generate_list "$1"
dl_game
